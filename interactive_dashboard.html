<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Monitor Dashboard</title>
  <link href="assets/css/style.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
  <style>
    /* Custom styles for active sidebar item */
    .sidebar-item.active {
      background-color: #4a5568; /* Gray background for active item */
      color: #48bb78; /* Green text for active item */
    }
    .sidebar-item.active svg {
      stroke: #48bb78; /* Green icon for active item */
    }

    .search-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    .search-container input {
      padding: 0.5rem;
      border: 1px solid #d1d5db; /* Gray border */
      border-radius: 0.375rem; /* Rounded corners */
      width: 200px; /* Fixed width for the search bar */
      outline: none;
      transition: border-color 0.2s;
    }
    .search-container input:focus {
      border-color: #3b82f6; /* Blue border on focus */
    }
  </style>
</head>

<body class="bg-gray-100">
  <!-- Main Flex Container -->
  <div class="flex h-screen bg-gray-800">
    
    <!-- Sidebar -->
    <aside class="w-60 bg-gray-800 text-white flex-shrink-0 overflow-y-auto">
      <div>
        <!-- Sidebar Header -->
        <div class="flex p-4 bg-gray-800">
          <p class="ml-2 font-semibold">PROCESS DASHBOARD</p>
        </div>

        <!-- Sidebar Navigation -->
        <ul class="mt-6">
          <li class="px-2 py-1 sidebar-item active" id="dashboard-nav">
            <a href="#" onclick="showDashboard()" class="flex items-center text-white hover:text-green-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M3 12l2-2 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              <span class="ml-4">DASHBOARD</span>
            </a>
          </li>
          <li class="px-2 py-1 sidebar-item" id="termination-log-nav">
            <a href="#" onclick="showTerminationLog()" class="flex items-center text-white hover:text-green-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              <span class="ml-4">Termination Log</span>
            </a>
          </li>
        </ul>
      </div>
    </aside>
    <!-- End of Sidebar -->

    <!-- Main Content Section -->
    <div class="flex-1 overflow-y-auto">
      <header class="bg-gray-800 py-4 px-6">
        <!-- Placeholder for header content -->
      </header>

      <!-- Dashboard Section -->
      <main id="dashboard-section" class="px-8 py-6">
        <!-- CPU and Memory Usage -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- CPU Usage -->
          <div class="bg-white p-4 shadow rounded-lg">
            <h5 class="text-lg font-medium">CPU Usage</h5>
            <h3 id="cpu-text" class="text-blue-500">--%</h3>
            <div id="cpu-chart" style="height: 200px;"></div>
          </div>

          <!-- Memory Usage -->
          <div class="bg-white p-4 shadow rounded-lg">
            <h5 class="text-lg font-medium">Memory Usage</h5>
            <h3 id="memory-text" class="text-green-500">--%</h3>
            <div id="memory-chart" style="height: 200px;"></div>
          </div>
        </div>

        <!-- Process Table -->
        <div class="bg-white mt-8 p-4 shadow rounded-lg">
          <h4 class="text-lg font-medium">Process List</h4>
          <!-- Search Bar -->
          <div class="search-container">
            <input type="text" id="process-search" placeholder="Search by process name..." />
          </div>
          <div class="overflow-x-auto">
            <table class="table-auto min-w-full">
              <thead>
                <tr>
                  <th class="px-4 py-2">PID</th>
                  <th class="px-4 py-2">Name</th>
                  <th class="px-4 py-2">CPU %</th>
                  <th class="px-4 py-2">Memory MB</th>
                  <th class="px-4 py-2">Threads</th>
                  <th class="px-4 py-2">Action</th>
                </tr>
              </thead>
              <tbody id="process-table-body">
                <!-- Process rows will be dynamically generated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Termination Log Section -->
      <div id="termination-log-section" class="px-8 py-6 hidden">
        <div class="bg-white p-4 shadow rounded-lg">
          <h4 class="text-lg font-medium text-gray-900">Termination Log</h4>
          <div class="overflow-x-auto">
            <table class="table-auto min-w-full">
              <thead>
                <tr>
                  <th class="px-4 py-2 text-gray-600">PID</th>
                  <th class="px-4 py-2 text-gray-600">Name</th>
                  <th class="px-4 py-2 text-gray-600">CPU %</th>
                  <th class="px-4 py-2 text-gray-600">Memory MB</th>
                  <th class="px-4 py-2 text-gray-600">Threads</th>
                </tr>
              </thead>
              <tbody id="termination-log-body">
                <!-- Terminated processes will be dynamically generated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cpuSeries = [], memorySeries = [];

    const cpuChart = new ApexCharts(document.querySelector("#cpu-chart"), {
      chart: { type: 'line', height: 200 },
      series: [{ name: "CPU %", data: [] }],
      xaxis: { type: 'datetime' },
      yaxis: { max: 100 }
    });

    const memoryChart = new ApexCharts(document.querySelector("#memory-chart"), {
      chart: { type: 'line', height: 200 },
      series: [{ name: "Memory %", data: [] }],
      xaxis: { type: 'datetime' },
      yaxis: { max: 100 }
    });

    cpuChart.render();
    memoryChart.render();

    function updateUsage() {
      fetch("/get_system_usage")
        .then(res => res.json())
        .then(data => {
          const now = new Date().getTime();
          cpuSeries.push([now, data.cpu_percent]);
          memorySeries.push([now, data.memory_percent]);
          if (cpuSeries.length > 20) cpuSeries.shift();
          if (memorySeries.length > 20) memorySeries.shift();
          cpuChart.updateSeries([{ data: cpuSeries }]);
          memoryChart.updateSeries([{ data: memorySeries }]);
          document.getElementById("cpu-text").innerText = data.cpu_percent + "%";
          document.getElementById("memory-text").innerText = data.memory_percent + "%";
        });
    }

    function updateProcessTable() {
      fetch("/get_processes")
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("process-table-body");
          table.innerHTML = "";
          data.forEach(p => {
            table.innerHTML += `
              <tr>
                <td class="px-4 py-2">${p.pid}</td>
                <td class="px-4 py-2">${p.name}</td>
                <td class="px-4 py-2">${p.cpu_percent}</td>
                <td class="px-4 py-2">${p.memory_usage.toFixed(2)}</td>
                <td class="px-4 py-2">${p.num_threads}</td>
                <td class="px-4 py-2"><button onclick="terminate(${p.pid})" class="bg-red-500 text-white px-2 py-1 rounded">Terminate</button></td>
              </tr>`;
          });
        });
    }


    function fetchAndUpdateProcesses() {
      fetch("/get_processes")
        .then(res => res.json())
        .then(data => {
          allProcesses = data; // Store all processes
          updateProcessTable(); // Display all processes initially
        });
    }


    function terminate(pid) {
      fetch("/terminate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pid })
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message || "Process terminated!");
          updateProcessTable();
        });
    }

    function showDashboard() {
      // Show dashboard section and hide termination log
      document.getElementById('dashboard-section').classList.remove('hidden');
      document.getElementById('termination-log-section').classList.add('hidden');

      // Update sidebar active state
      document.getElementById('dashboard-nav').classList.add('active');
      document.getElementById('termination-log-nav').classList.remove('active');
    }

    function showTerminationLog() {
      // Hide dashboard section and show termination log
      document.getElementById('dashboard-section').classList.add('hidden');
      document.getElementById('termination-log-section').classList.remove('hidden');

      // Update sidebar active state
      document.getElementById('dashboard-nav').classList.remove('active');
      document.getElementById('termination-log-nav').classList.add('active');

      // Fetch the terminated processes log
      fetch("/get_terminated_processes")
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("termination-log-body");
          table.innerHTML = "";
          data.forEach(p => {
            table.innerHTML += `
              <tr>
                <td class="px-4 py-2">${p.pid}</td>
                <td class="px-4 py-2">${p.name}</td>
                <td class="px-4 py-2">${p.cpu_percent}</td>
                <td class="px-4 py-2">${p.memory_usage.toFixed(2)}</td>
                <td class="px-4 py-2">${p.num_threads}</td>
              </tr>`;
          });
        });
    }

    // Search functionality
    document.getElementById("process-search").addEventListener("input", function() {
      const searchTerm = this.value.toLowerCase();
      const filteredProcesses = allProcesses.filter(process => 
        process.name.toLowerCase().includes(searchTerm)
      );
      updateProcessTable(filteredProcesses);
    });

    setInterval(() => {
      updateUsage();
      updateProcessTable();
    }, 5000);

    updateUsage();
    fetchAndUpdateProcesses();
  </script>
</body>
</html>
